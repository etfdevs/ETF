name: build

on:
  workflow_dispatch:
  push:
    branches: [master]
    tags-ignore:
      - '*'
    paths-ignore:
      - docs/*
      - .gitignore
      - .gitattributes
      - .clang-format
      - README.md
      - VERSION.txt
      - release.sh
  pull_request:
    branches: [master]
    paths-ignore:
      - docs/*
      - .gitignore
      - .gitattributes
      - .clang-format
      - README.md
      - VERSION.txt
      - release.sh
  merge_group:

jobs:
  Windows-MSVC:
    name: Windows-MSVC ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [ x86, x64 ]
        config: [Release]
        include:
          - arch: x86
            platform: Win32

          - arch: x64
            platform: x64
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure CMake
      run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ matrix.config }} -G "Visual Studio 18 2026" -A ${{ matrix.platform }}

    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config ${{ matrix.config }} --parallel

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: etf-artifacts-win-${{ matrix.arch }}
        path: ${{ github.workspace }}/build/etf

  Linux:
    name: Linux ${{ matrix.arch }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x86_64]
        config: [Release]

    steps:
    - name: Install dependencies
      if: matrix.arch == 'x86'
      run: |
        sudo apt-get update
        sudo apt-get install gcc-multilib g++-multilib

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure CMake
      run: |
        if [ ${{ matrix.arch }} == "x86" ]; then
          cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ matrix.config }} -DCMAKE_TOOLCHAIN_FILE=cmake/Toolchain-cross-x86-linux.cmake
        else
          cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ matrix.config }}
        fi

    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config ${{ matrix.config }} --parallel

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: etf-artifacts-linux-${{ matrix.arch }}
        path: ${{ github.workspace }}/build/etf

  macOS:
    name: macOS ${{ matrix.arch }}
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64]
        config: [Release]
        include:
          - osx-target: "10.13"
  
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
  
    - name: Configure CMake
      run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ matrix.config }} -DCMAKE_OSX_ARCHITECTURES=${{ matrix.platforms }} -DCMAKE_OSX_DEPLOYMENT_TARGET=${{ matrix.osx-target }}
  
    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config ${{ matrix.config }} --parallel
  
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: etf-artifacts-macos-${{ matrix.arch }}
        path: ${{ github.workspace }}/build/etf

  macOS-universal:
    name: macOS Universal Binaries
    runs-on: macos-14
    needs: [macOS]
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: etf-artifacts-macos-*
          path: artifacts

      - name: Create universal binaries
        run: |
          mkdir -p build-universal
          cp -R artifacts/etf-artifacts-macos-arm64/* build-universal
          lipo -create artifacts/etf-artifacts-macos-x86_64/cgame_mac \
                       artifacts/etf-artifacts-macos-arm64/cgame_mac \
                -output build-universal/cgame_mac
          lipo -create artifacts/etf-artifacts-macos-x86_64/ui_mac \
                       artifacts/etf-artifacts-macos-arm64/ui_mac \
                -output build-universal/ui_mac
          lipo -create artifacts/etf-artifacts-macos-x86_64/qagame_mac \
                       artifacts/etf-artifacts-macos-arm64/qagame_mac \
                -output build-universal/qagame_mac

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: etf-artifacts-macos-universal
          path: ${{ github.workspace }}/build-universal

      # cleanup the individual builds so package doesn't download them
      - name: Cleanup
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            etf-artifacts-macos-arm64
            etf-artifacts-macos-x86_64
        
  package:
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [Windows-MSVC, Linux, macOS-universal]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with: 
          pattern: etf-artifacts-*
          merge-multiple: true
          path: ${{ github.workspace }}/build/etf

      - name: Pack release zip
        working-directory: ${{ github.workspace }}/build
        run: |
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make mod_release

      - name: Upload release 
        uses: actions/upload-artifact@v4
        with:
          name: etf-snapshot-release
          path: ${{ github.workspace }}/build/*.zip

      - name: Create latest build
        uses: czietz/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: "latest"
          prerelease: false
          title: Latest Build
          files: ${{ github.workspace }}/build/*.zip
